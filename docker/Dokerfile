FROM condaforge/mambaforge

USER root

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get -qq update --yes \
  && apt-get -qq install --yes --no-install-recommends \
  build-essential firefox\
  ca-certificates sudo \
  && rm -rf /var/lib/apt/lists/*

RUN addgroup --gid 1000 developer \
  && useradd --uid 1000 --gid 1000 -ms /bin/bash developer \
  && echo "developer ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/developer \
  && chmod 0440 /etc/sudoers.d/developer

# Copy environment file to tmp/
COPY environment.yaml /tmp/environment.yaml

# Copy script for notebooks tests
COPY --chown=developer:developer docker/test_notebooks.sh /home/developer/test_notebooks.sh

# Use environment to update the env base
RUN mamba update --all --yes --quiet \
  && mamba env update --file /tmp/environment.yaml --name base \
  && mamba clean -afy

USER developer

ENV HOME /home/developer

WORKDIR /home/developer/pysus/Notebooks

ENTRYPOINT exec jupyter-lab --ip=0.0.0.0 --port=8888 --browser='firefox'  --allow-root --NotebookApp.token="" --NotebookApp.password=""

CMD /usr/bin/firefox
